{% extends 'dashboard.html' %}
{% load static %}
{% block title %} Mapa en Tiempo Real {% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
	<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
		<h1 class="h2">Ubicación Flota en Tiempo Real</h1>
	</div>
	<div id="map" style="height: 600px"></div>
	<div id="error-message" style="color: red; font-weight: bold; display: none;">
	    Error al cargar datos GPS.
	</div>
</main>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    var map = L.map("map").setView([-33.4489, -70.6693], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    var activeIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
    });

    function refreshMarkers() {
        fetch('/api/gps-data/')
            .then(response => response.json())
            .then(data => {
                // Limpia los marcadores existentes
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                // Agrega nuevos marcadores
                data.forEach(entry => {
                    L.marker([entry.latitud, entry.longitud], { icon: activeIcon })
                        .addTo(map)
                        .bindPopup(`
                            <b>Conductor:</b> ${entry.conductor}<br>
                            <b>Vehículo:</b> ${entry.vehiculo}<br>
                            <b>Hora:</b> ${entry.timestamp}<br>
                            <b>Estado:</b> ${entry.estado}
                        `);
                });
            })
            .catch(err => console.error("Error refrescando datos GPS:", err));
    }

    // Refresca cada 5 segundos
    setInterval(refreshMarkers, 5000);
</script>

{% endblock %}
